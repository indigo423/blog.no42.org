<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Ronny Trommer">
        <meta name="description" content="Private blog around tech and live.">
        <meta name="keywords" content="blog,personal,responsive,search,font awesome,pages,posts,multilingual,highlight.js,syntax highlighting,premium,shortcuts">
        <meta name="generator" content="Hugo 0.55.4" />
        <title> Build OpenNMS with Docker | no42</title>
        <meta name="description" content="Build OpenNMS with Docker - Private blog around tech and live.">
        <meta itemprop="name" content="Build OpenNMS with Docker">
        <meta itemprop="description" content="Build OpenNMS with Docker - Private blog around tech and live.">
        <meta property="og:title" content="Build OpenNMS with Docker">
        <meta property="og:description" content="Build OpenNMS with Docker - Private blog around tech and live.">
        <meta property="og:image" content="https://www.gravatar.com/avatar/7f19843706ee328d5b1dfbf9b2a73a73?size=200">
        <meta property="og:url" content="https://blog.no42.org/code/build-opennms-docker/">
        <meta property="og:site_name" content="no42">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="https://blog.no42.org/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://blog.no42.org/favicon-16x16.png" sizes="16x16">

	

        
        
        
        
        <link rel="stylesheet" href="https://blog.no42.org/sass/combined.min.6e8351b3ea65d753e797df34276a01509dc8ac2d5d2f5d5b13934de1e37d5d44.css">

        

        
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav>

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="/page/projects/">Projects</a></li>
                
            
                
                    <li><a href="/page/about/">About Me</a></li>
                
            
                
                    <li><a href="/page/impressum/">Impressum</a></li>
                
            
                
                    <li><a href="/page/privacy/">Privacy</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="/images/gravatar.jpg" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="/">no42</a></h3>
            
                <span class="subtitle">... search for answer?</span>
            
        </div>

    

        
        <div class="toggler">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="/code/build-opennms-docker/">
    <i class="fa fa-fw fa-code"></i>
</a>

<article class="default article">
    
    <div class="featured-image">
        <a href="/code/build-opennms-docker/">
            
                <img src="/code/build-opennms-docker/featuredImage_hu4056c5a21a2db14222ae75293e1861b1_555186_700x350_fill_q95_box_smart1_2.png" alt="">
            
        </a>
    </div>


    <div class="content">
    <h3><a href="/code/build-opennms-docker/">Build OpenNMS with Docker</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2018-07-14</span>
            
        

        
            <span class="readingTime">4 min read</span>
        

        

        
            <span class="author"><a href="/author/ronny-trommer">Ronny Trommer</a></span>
        
    </div>

    
        

<p>Being able to compiling an Open Source project is important.
You can change the code, so you should also able to build it.</p>

<p>Why is there a dedicated Docker image for the build environment?
The dependencies running a pre-build OpenNMS Horizon distribution and compiling from source are different.
To build OpenNMS Horizon you need Apache Maven and to compile JICMP, JRRD you need a C compiler environment.
This is nothing you want to carry when you just want to run OpenNMS Horizon.</p>

<p>The build environment for OpenNMS depends on the following components and is easiest built on a Linux CentOS 7 environment.</p>

<p>What do you need to compile OpenNMS:</p>

<ul>
<li>Linux with git</li>
<li>OpenJDK Development Kit 8</li>
<li>Apache Maven</li>
<li>gcc with C++ build environment</li>
<li>When you want to run OpenNMS you need at least JRRD, JICMP and PostgreSQL</li>
</ul>

<p>Docker is a great way to bundle these dependencies into a runnable build image.
As soon you have a box which has a running Docker daemon running you can use our <a href="https://hub.docker.com/r/opennms/build-env">Docker Build Environment</a> to compile and build OpenNMS Horizon from source and you can run it in a isolated Docker environment.</p>

<h3 id="the-basics-to-build-and-assemble">The Basics to Build and Assemble</h3>

<p>This example gives you the possiblity to build and run multiple branches, so every branch gets his own directory with the branch name as a namespace.</p>

<p><strong><em>Step 1: Make a workspace directory where we mess around.</em></strong></p>

<pre><code class="language-sh">cd ${HOME}
mkdir workspace
cd workspace
</code></pre>

<p><strong><em>Step 2: Checkout the OpenNMS Horizon source code from GitHub</em></strong></p>

<pre><code class="language-sh">git clone https://github.com/OpenNMS/opennms.git develop/opennms
# Develop is checkout by default, if you want a custom branch check it out with git checkout origin/&lt;branch-name&gt;
</code></pre>

<p><strong><em>Step 3: Compile OpenNMS Horizon and tag the running docker instance to make it easier to identify the running build process</em></strong></p>

<pre><code class="language-sh">docker run --rm \
    -l &quot;branch=develop&quot; \
    -v $(pwd)/develop/opennms:/usr/src/opennms \
    -v $(pwd)/m2:/root/.m2 \
    -v $(pwd)/develop/m2:/root/.m2/repository/org/opennms \
    opennms/build-env:latest /usr/bin/perl compile.pl -DskipTests
</code></pre>

<p><strong><em>Step 4: Assemble OpenNMS Horizon so it can be started from /opt/opennms</em></strong></p>

<pre><code class="language-sh">docker run --rm \
    -l &quot;branch=develop&quot; \
    -v $(pwd)/develop/opennms:/usr/src/opennms \
    -v $(pwd)/m2:/root/.m2 \
    -v $(pwd)/develop/m2:/root/.m2/repository/org/opennms \
    opennms/build-env:latest /usr/bin/perl ./assemble.pl -DskipTests -p dir -Dopennms.home=/opt/opennms
</code></pre>

<h3 id="dealing-with-maven-home">Dealing with Maven Home</h3>

<p>The Maven home directory is the place where all Java dependencies are downloaded.
The first build will take a while, cause all these dependencies needs to be downloaded and are cached in the home directory of the user who compiles it.
In our case this is in the container <code>/root/.m2</code>.</p>

<p>You notice in the <code>docker run</code> commands, we create a global m2 directory.
So it needs to be populated once and can be reused in every other branch we build.</p>

<pre><code class="language-sh">-v $(pwd)/m2:/root/.m2 \
</code></pre>

<p>Maven artifacts are stored by version numbers.
For the reason branches forked from develop have all the same version number <code>23.0.0-SNAPSHOT</code>.
If you want to build multiple branches they can mess things up.
So we have to isolate all OpenNMS related artifacts from each other.
We just mount <code>.m2/repository/org/opennms</code> directory to a dedicated place in the branch directory.</p>

<pre><code class="language-sh">-v $(pwd)/develop/m2:/root/.m2/repository/org/opennms \
</code></pre>

<p>That way we can leverage from a shared local Maven repository and have branch specific places for OpenNMS Horizon artifacts.</p>

<p>I&rsquo;ve put things described here in a convinient <a href="https://github.com/opennms-forge/build-workbench/blob/master/docker-build.sh">bash script</a> which can be run from a workspace directory.</p>

<pre><code class="language-sh">./docker-build.sh -b jira/NMS-9858
</code></pre>

<p>It will checkout the source code, build and assemble for a given branch.</p>

<h3 id="running-with-docker">Running with Docker</h3>

<p>So now you have built and assembled everything you want to start it.
You can use the <code>opennms/build-env:latest</code> image also to start a built OpenNMS Horizon.
It has the same <code>docker-entrypoint.sh</code> as the <a href="https://hub.docker.com/r/opennms/horizon-core-web/">Docker image</a> you can use with the pre-installed one.
The <code>build-env</code> image gives freedom to run things, you have to call it explicitly in the <code>command</code> section in your <code>docker-compose.yml</code> file.</p>

<pre><code class="language-yaml">command: [&quot;/docker-entrypoint.sh&quot;, &quot;-s&quot;]
</code></pre>

<p>We assembled the compiled source code to run in <code>/opt/opennms</code>, so we can just mount it in the right place.</p>

<pre><code class="language-yaml">volumes:
  - ./opennms/target/opennms-23.0.0-SNAPSHOT:/opt/opennms
</code></pre>

<p>The ports for the webapp are by default published to dynamic addresses, so you can run multiple stacks of OpenNMS Horizon on the same host.
You can see the port mapping by running <code>docker ps</code>, in this example the TCP port 32787 is mapped to the Horizon webapp and you can access the webui with <a href="http://hostip:32787">http://hostip:32787</a>.</p>

<p>Feel free to download and make them better in our <a href="https://github.com/opennms-forge/build-workbench">GitHub Repository</a>.</p>

<p>Happy Dockering</p>

    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="/tags/opennms">opennms</a>
                
                    <a href="/tags/docker">docker</a>
                
                    <a href="/tags/cicd">cicd</a>
                
                    <a href="/tags/java">java</a>
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="/code/docker-build-cache-invalidation/">Docker build and cache invalidation</a>
                    </li>
                
                    <li>
                        <a href="/code/docker-java-signals-pid1/">Docker, Java, Signals and Pid 1</a>
                    </li>
                
                    <li>
                        <a href="/code/ssl-and-java/">SSL and Java</a>
                    </li>
                
                    <li>
                        <a href="/article/opennms-notify-signal/">Send notifications with Signal</a>
                    </li>
                
                    <li>
                        <a href="/article/theming-applications/">Everyone can change it and why you shouldn&#39;t</a>
                    </li>
                
                    <li>
                        <a href="/article/guidance-to-survive-monitoring/">Guidance to Survive Monitoring</a>
                    </li>
                
                    <li>
                        <a href="/quote/two-hard-things/">Two hard things</a>
                    </li>
                
                </ul>
        </div>
        

        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                    <a href="https://twitter.com/indigo423" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                    <a href="https://www.xing.com/profile/Ronny_Trommer" target="_blank"><i class="fa fa-xing"></i></a>
                
                
                
                
                
                
                
                    <a href="https://github.com/indigo423" target="_blank"><i class="fa fa-github"></i></a>
                
                
                    <a href="https://www.linkedin.com/in/ronnytrommer/" target="_blank"><i class="fa fa-linkedin"></i></a>
                
            </div>
            

            <div class="languages">
                    <strong>Other languages</strong>
                    
                        
                            <a href="/en" class="active">en</a>
                        
                    
                        
                            <a href="/de">de</a>
                        
                    
                </div>
            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/indigo423" target="_blank">
                &copy;
                
                    2019
                
                by Ronny Trommer
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-73787628-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


        

        
        
        <script type="text/javascript" src="https://blog.no42.org/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="https://blog.no42.org/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
        

        


    </body>
</html>
