<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Ronny Trommer">
        <meta name="description" content="Private blog around tech and live.">
        <meta name="keywords" content="blog,personal,responsive,search,font awesome,pages,posts,multilingual,highlight.js,syntax highlighting,premium,shortcuts">
        <meta name="generator" content="Hugo 0.55.4" />
        <title> Centralized Logging with Graylog2 | no42</title>
        <meta name="description" content="Centralized Logging with Graylog2 - Private blog around tech and live.">
        <meta itemprop="name" content="Centralized Logging with Graylog2">
        <meta itemprop="description" content="Centralized Logging with Graylog2 - Private blog around tech and live.">
        <meta property="og:title" content="Centralized Logging with Graylog2">
        <meta property="og:description" content="Centralized Logging with Graylog2 - Private blog around tech and live.">
        <meta property="og:image" content="https://www.gravatar.com/avatar/7f19843706ee328d5b1dfbf9b2a73a73?size=200">
        <meta property="og:url" content="https://blog.no42.org/code/centralized-logging-graylog2/">
        <meta property="og:site_name" content="no42">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="https://blog.no42.org/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://blog.no42.org/favicon-16x16.png" sizes="16x16">

	

        
        
        
        
        <link rel="stylesheet" href="https://blog.no42.org/sass/combined.min.6e8351b3ea65d753e797df34276a01509dc8ac2d5d2f5d5b13934de1e37d5d44.css">

        

        
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav>

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="/page/projects/">Projects</a></li>
                
            
                
                    <li><a href="/page/about/">About Me</a></li>
                
            
                
                    <li><a href="/page/impressum/">Impressum</a></li>
                
            
                
                    <li><a href="/page/privacy/">Privacy</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="/images/gravatar.jpg" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="/">no42</a></h3>
            
                <span class="subtitle">... search for answer?</span>
            
        </div>

    

        
        <div class="toggler">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="/code/centralized-logging-graylog2/">
    <i class="fa fa-fw fa-code"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="/code/centralized-logging-graylog2/">Centralized Logging with Graylog2</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2017-11-17</span>
            
        

        
            <span class="readingTime">3 min read</span>
        

        

        
            <span class="author"><a href="/author/ronny-trommer">Ronny Trommer</a></span>
        
    </div>

    
        

<p>How many times do you connect with SSH to your remote server and <code>cat</code>, <code>grep</code>, <code>tail</code> and <code>awk</code> through your logs?
It probably works for 3 servers and running a handful services, but if you have more, you should definitely spend some time to centralize your logs.</p>

<p>I personally prefer <a href="https://www.graylog.org">Graylog2</a> which can deal very well with different log formats like <a href="http://docs.graylog.org/en/2.3/pages/gelf.html">GELF</a>, <a href="https://de.wikipedia.org/wiki/Syslog">Syslog RFC&rsquo;s</a>.
Just start some listener with the format and forward them to your <em>Graylog2</em> instance.</p>

<p>A few servers are <a href="https://en.wikipedia.org/wiki/Network_address_translation">NAT&rsquo;ed</a> behind <a href="https://en.wikipedia.org/wiki/VDSL">VDSLs</a> with dynamic IP&rsquo;s and some physical and virtual servers hosted somewhere else with static public IP&rsquo;s which have all running <em>Linux</em>.
This makes monitoring normally hard, so I use a fully meshed <a href="https://www.tinc-vpn.org">tinc</a> VPN, so I don&rsquo;t have to deal a lot securing many different applications and protocols and everything is reachable in a flat private /24 IPv4 network.
To manage the server basic configuration I use <a href="https://www.ansible.com">Ansible</a> and most services run as a container using <a href="https://www.docker.com">Docker</a>.</p>

<p>What is the benefit?</p>

<ul>
<li>The <em>GELF</em> listener allows me to the Docker built-in driver to easily centralize containerized application logs</li>
<li><a href="https://logging.apache.org/log4j/2.x/">Log4j2</a> provides a <em>GELF</em> output as well which gives me full access to my logs from my <em>OpenNMS</em> instances</li>
<li><em>Graylog2</em> can parse Syslog in various RFC&rsquo;s which gives me centralized system logs from my Linux systems</li>
<li>It is very easy to deploy the configurations with <em>Ansible</em></li>
</ul>

<h2 id="setting-up-a-graylog2-service-stack">Setting up a Graylog2 Service Stack</h2>

<p>Define a service stack using <a href="https://docs.docker.com/compose/">Docker Compose</a> and get Graylog2 up and running.
Here is <a href="https://gist.github.com/indigo423/b6f1594e2512fddb0e677435937e8937">docker-compose.yml file</a> I use, just download it and run <code>docker-compose up -d</code>.</p>

<p>The following ports get exposed:</p>

<ul>
<li>9000: The Graylog2 web application</li>
<li>12201: GELF UDP listener for my Java applications</li>
<li>514: GELF UDP Syslog listener to forward my system logs</li>
</ul>

<h2 id="configure-a-gelf-udp-and-a-syslog-udp-input">Configure a GELF UDP and a Syslog UDP Input</h2>

<p>With the first login in <em>Graylog2</em> you have to create two <em>Inputs</em>.
The <em>GELF UDP</em> input is used to receive log messages from my <em>OpenNMS</em> applications and <em>Docker Daemons</em> and the <em>Syslog UDP</em> input receives my <em>Syslog</em> messages.</p>

<p><img src="/images/graylog2-inputs.png" alt="Graylog2 Input Configuration" /></p>

<h2 id="configure-syslog-forwarder">Configure Syslog forwarder</h2>

<p>On my systems is <a href="http://www.rsyslog.com">rsyslog</a> running.
It is required to configure <em>rsyslogd</em> and I use <em>Ansible</em> to create a file in <code>/etc/rsyslog.d/50-graylog-forwarding</code> with following content:</p>

<pre><code class="language-sh">if $programname == 'snmpd' and $msg contains 'statfs' then {
    stop
}

*.* @172.42.42.42:514;RSYSLOG_SyslogProtocol23Format
</code></pre>

<p>On 172.42.42.42, my Graylog2 instance is running and is listening on 514/udp.
After restarting <em>rsyslog</em> the logs will be forwarded.
The first if-statement ensures I don&rsquo;t log a lot of garbage coming from <code>snmpd</code> which described more in detail in this <a href="https://blog.no42.org/blog/cleaner-logs-docker-snmp">blog post</a>.</p>

<h2 id="configure-opennms-to-forward-logs-to-graylog2">Configure OpenNMS to forward logs to Graylog2</h2>

<p>Add Modify the <code>${OPENNMS_HOME/etc/log4j2.xml</code> and add a GELF UDP log appender which is described in our <a href="https://wiki.opennms.org/wiki/Sending_OpenNMS_Logs_to_Graylog">OpenNMS Wiki</a>.</p>

<p>All the daemons will no also forward their logs to Graylog2 via UDP and are searchable for services node labels, node ids and daemons.
Different OpenNMS instances running various versions are identified by an application_name` tag.</p>

<p><img src="/images/graylog2-screenshot.png" alt="Graylog2 Screenshot" /></p>

<h2 id="forward-docker-container-logs">Forward Docker Container logs</h2>

<p>To get logs from my applications running in Docker container, I have configured them to use the GELF driver by just adding this snippet to my service definition:</p>

<pre><code class="language-sh">logging:
  driver: &quot;gelf&quot;
  options:
    gelf-address: &quot;udp://172.42.42.42:12201&quot;
    tag: &quot;horizon-core-web:stable&quot;
</code></pre>

<p>The <code>tag</code> is used to identify the service, you can be as creative as you want and the <code>gelf-address</code> tells the Docker daemon where to forward the messages which is my <em>Graylog2</em> listener input.</p>

<p>Happy logging and searching</p>

    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="/tags/monitoring">monitoring</a>
                
                    <a href="/tags/logging">logging</a>
                
                    <a href="/tags/opennms">opennms</a>
                
                    <a href="/tags/java">java</a>
                
                    <a href="/tags/syslog">syslog</a>
                
                    <a href="/tags/gelf">gelf</a>
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="/code/docker-build-cache-invalidation/">Docker, Caching, Build</a>
                    </li>
                
                    <li>
                        <a href="/code/docker-java-signals-pid1/">Docker, Java, Signals and Pid 1</a>
                    </li>
                
                    <li>
                        <a href="/code/ssl-and-java/">SSL and Java</a>
                    </li>
                
                    <li>
                        <a href="/article/opennms-notify-signal/">Send notifications with Signal</a>
                    </li>
                
                    <li>
                        <a href="/article/theming-applications/">Everyone can change it and why you shouldn&#39;t</a>
                    </li>
                
                    <li>
                        <a href="/article/guidance-to-survive-monitoring/">Guidance to Survive Monitoring</a>
                    </li>
                
                    <li>
                        <a href="/quote/two-hard-things/">Two hard things</a>
                    </li>
                
                </ul>
        </div>
        

        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                    <a href="https://twitter.com/indigo423" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                    <a href="https://www.xing.com/profile/Ronny_Trommer" target="_blank"><i class="fa fa-xing"></i></a>
                
                
                
                
                
                
                
                    <a href="https://github.com/indigo423" target="_blank"><i class="fa fa-github"></i></a>
                
                
                    <a href="https://www.linkedin.com/in/ronnytrommer/" target="_blank"><i class="fa fa-linkedin"></i></a>
                
            </div>
            

            <div class="languages">
                    <strong>Other languages</strong>
                    
                        
                            <a href="/en" class="active">en</a>
                        
                    
                        
                            <a href="/de">de</a>
                        
                    
                </div>
            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/indigo423" target="_blank">
                &copy;
                
                    2019
                
                by Ronny Trommer
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-73787628-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


        

        
        
        <script type="text/javascript" src="https://blog.no42.org/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="https://blog.no42.org/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
        

        


    </body>
</html>
